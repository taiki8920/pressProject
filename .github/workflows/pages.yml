name: Build and deploy Press Project site

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_network:
        description: "Set to 1 to skip network calls (dry-run)"
        required: false
        default: "0"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run site generation (main.py)
        # Do not fail the workflow on generation errors; we will surface counts as warnings.
        continue-on-error: true
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SKIP_NETWORK: ${{ github.event.inputs.skip_network || '0' }}
        run: |
          # ensure SKIP_NETWORK has a sensible default in-shell as well
          SKIP_NETWORK=${SKIP_NETWORK:-0}
          echo "Running main.py (SKIP_NETWORK=$SKIP_NETWORK)"
          python src/main.py 2>&1 | tee generation.log
          echo "--- Summary ---"
          # count generated HTML files
          GENERATED=$(grep -c "Wrote:" generation.log || true)
          echo "Articles generated (Wrote: lines): $GENERATED"
          echo "Errors/Warnings captured (first 100 lines):"
          grep -i "failed\|exception\|error" generation.log | head -n 100 || true

      - name: Show generation log (truncated)
        if: always()
        run: |
          echo "==== generation.log (first 200 lines) ===="
          head -n 200 generation.log || true

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          publish_branch: gh-pages
